
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  html, body {
    width: 100vw;
    height: 100vh;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    box-sizing: border-box;
    font-family: 'Poppins', Arial, Helvetica, sans-serif;
    color: #23272f;
  }
  *, *::before, *::after {
    color: #23272f !important;
    font-family: 'Poppins', Arial, Helvetica, sans-serif !important;
  }
  .dashboard-flex-main {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    justify-content: stretch;
    width: 100vw;
    min-height: 90vh;
    box-sizing: border-box;
    gap: 0;
    margin: 0;
    padding: 0;
  }
  .dashboard-analytics {
    flex: 1 1 0;
    padding: 32px 0 0 0;
    max-width: 100vw;
    min-width: 0;
    box-sizing: border-box;
  }
  .dashboard-bot {
    width: 420px;
    min-width: 320px;
    max-width: 520px;
    height: 100vh;
    background: #fafbfc;
    border-left: 1.5px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: flex-start;
    box-sizing: border-box;
    position: sticky;
    top: 0;
    right: 0;
    z-index: 2;
    padding: 0;
  }
  .dashboard-bot iframe {
    width: 100%;
    height: 100vh;
    border: none;
    border-radius: 0;
    background: #fafbfc;
    display: block;
  }
  @media (max-width: 1100px) {
    .dashboard-flex-main {
      flex-direction: column;
    }
    .dashboard-bot {
      width: 100vw;
      min-width: 0;
      max-width: 100vw;
      height: 60vh;
      border-left: none;
      border-top: 1.5px solid #e5e7eb;
      position: static;
    }
    .dashboard-bot iframe {
      height: 60vh;
    }
    .dashboard-analytics {
      padding: 24px 8px 0 8px;
    }
  }
</style>

<div class="dashboard-flex-main">
  

  <div class="dashboard-analytics"style="display: flex; flex-direction: column;">
  <div class="logos" style="display: flex; align-items: center; margin-left: 4%;">
    <img src="{{url_for('static', filename='images/rj.png')}}" alt="" style="width: 30px; height: 30px; margin-right: 12px;">
    <div>
      <h3 style="margin: 0; font-size: 1.25rem;">Centrifuge HIRE</h3>
      <p style="margin: 2px 0 0 0; font-size: 0.92rem; color: #888; font-weight: 400;">Powered by Ai</p>
    </div>
  </div>

    <!-- Analytics Charts Side by Side -->
    <div style="width:100%; max-width:900px; margin:0 auto 0 auto; display:flex; flex-direction:row; gap:32px; align-items:flex-start; justify-content:center;">
      <!-- Candidate Metrics Chart (Radar) -->
       
      <div style="flex:1; min-width:260px; max-width:340px;">
        <h2 style="color:#1976d2; margin-bottom:8px; font-size:1.1rem;">Total Applicants</h2>
        <!-- Removed separate radar label links -->
        <div class="chart-wrapper" style="width:100%; max-width:320px; margin-bottom:0;">
          <canvas id="radarChart" width="220" height="220"></canvas>
        </div>
      </div>
      <!-- Line Chart for Vacancies vs Hired -->
      <div style="flex:1; min-width:260px; max-width:340px;">
        <div class="period-selector" style="margin-bottom:6px; display:flex; gap:8px; align-items:center;">
          <label for="periodSelect"><b>Show for:</b></label>
          <select id="periodSelect">
            <option value="month">Months</option>
            <option value="week">Weeks</option>
            <option value="day">Days</option>
          </select>
        </div>
        <h2 style="color:#1976d2; margin-bottom:8px; font-size:1.1rem;">Vacancies vs Hired</h2>
        <div class="linechart-wrapper" style="width:100%; max-width:320px; margin-bottom:0;">
          <canvas id="vacancyHiredLineChart" width="220" height="220"></canvas>
        </div>
      </div>
    </div>

    <!-- Milestones & Key Metrics -->
    <div style="width:100%; max-width:900px; margin:36px auto 10px auto; text-align:center;">
      <h2 style="font-size:1.5rem; color:#1976d2; font-weight:700; margin-bottom:4px;">Milestones & Key Metrics</h2>
    </div>
    <div id="metricsSection" style="width:100%; max-width:900px; margin:32px auto 0 auto; display:flex; gap:32px; justify-content:center; align-items:center;">
      <div style="flex:1; min-width:160px; text-align:center;">
        <a href="/milestones_breakup/total_applicants" style="text-decoration:none; color:inherit; cursor:pointer;">
          <div id="countApplicants" style="font-size:2.1rem; font-weight:700; color:#1976d2;">0</div>
          <div style="font-size:1.05rem; color:#444;">Total Applicants</div>
        </a>
      </div>
      <div style="flex:1; min-width:160px; text-align:center;">
        <a href="/milestones_breakup/hired" style="text-decoration:none; color:inherit; cursor:pointer;">
          <div id="countHired" style="font-size:2.1rem; font-weight:700; color:#43a047;">0</div>
          <div style="font-size:1.05rem; color:#444;">Hired</div>
        </a>
      </div>
      <div style="flex:1; min-width:160px; text-align:center;">
        <a href="/milestones_breakup/attrition_score" style="text-decoration:none; color:inherit; cursor:pointer;">
          <div id="countAttrition" style="font-size:2.1rem; font-weight:700; color:#e67e22;">0%</div>
          <div style="font-size:1.05rem; color:#444;">Attrition Score</div>
        </a>
      </div>
    </div>
  </div>
  <div class="dashboard-bot">
    <iframe src="http://127.0.0.1:5001/" frameborder="0">
      Your browser does not support iframes.
    </iframe>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Candidate Metrics Chart (Radar) with clickable labels
(function() {
  let radarLabels = [];
  let radarData = [];
  try {
    radarLabels = JSON.parse('{{ radar_labels_json | safe }}');
    radarData = JSON.parse('{{ radar_data_json | safe }}');
  } catch (e) {}
  const radarCanvas = document.getElementById('radarChart');
  // Removed rendering of clickable links above the radar chart
  if (radarCanvas && radarLabels.length && radarData.length) {
    const chart = new Chart(radarCanvas.getContext('2d'), {
      type: 'radar',
      data: {
        labels: radarLabels,
        datasets: [{
          label: 'Candidate Metrics',
          data: radarData,
          fill: true,
          backgroundColor: 'rgba(37, 99, 235, 0.2)',
          borderColor: 'rgba(37, 99, 235, 1)',
          pointBackgroundColor: 'rgba(37, 99, 235, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(37, 99, 235, 1)'
        }]
      },
      options: {
        scales: {
          r: {
            angleLines: { display: true },
            suggestedMin: 0,
            suggestedMax: Math.max(...radarData, 5),
            pointLabels: { font: { size: 12, weight: '600' } }
          }
        },
        plugins: {
          legend: { display: false },
          title: { display: false }
        }
      }
    });

    // Helper to get label positions
    function getLabelPositions() {
      const positions = [];
      const cx = chart.scales.r.xCenter;
      const cy = chart.scales.r.yCenter;
      const outerRadius = chart.scales.r.drawingArea;
      const labelCount = radarLabels.length;
      for (let i = 0; i < labelCount; i++) {
        // Chart.js uses -Math.PI/2 as 0 angle, then clockwise
        const angle = (Math.PI / 2) - (2 * Math.PI * i / labelCount);
        const lx = cx + Math.cos(angle) * outerRadius;
        const ly = cy - Math.sin(angle) * outerRadius;
        positions.push({x: lx, y: ly, label: radarLabels[i]});
      }
      return positions;
    }

    // Click event for labels
    radarCanvas.addEventListener('click', function(event) {
      const rect = radarCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const positions = getLabelPositions();
      for (let i = 0; i < positions.length; i++) {
        const {x: lx, y: ly, label} = positions[i];
        if (Math.hypot(x - lx, y - ly) < 28) {
          const slug = label.toLowerCase().replace(/\s+/g, '_');
          window.location.href = `/breakdown/${slug}`;
          break;
        }
      }
    });

    // Pointer cursor on hover over labels
    radarCanvas.addEventListener('mousemove', function(event) {
      const rect = radarCanvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      const positions = getLabelPositions();
      let over = false;
      for (let i = 0; i < positions.length; i++) {
        const {x: lx, y: ly} = positions[i];
        if (Math.hypot(x - lx, y - ly) < 28) {
          over = true;
          break;
        }
      }
      radarCanvas.style.cursor = over ? 'pointer' : 'default';
    });
  }
})();


// Line Chart for Vacancies vs Hired
let vacancyHiredLabels, totalVacanciesData, totalHiredData;
try {
  vacancyHiredLabels = JSON.parse('{{ vacancy_hired_labels_json | safe }}');
  totalVacanciesData = JSON.parse('{{ total_vacancies_data_json | safe }}');
  totalHiredData = JSON.parse('{{ total_hired_data_json | safe }}');
} catch (e) {
  console.error('Error parsing chart data:', e);
}

let lineChartInstance = null;
function renderLineChart(labels, vacancies, hired) {
  const canvas = document.getElementById('vacancyHiredLineChart');
  if (!canvas) {
    console.error('Line chart canvas not found');
    return;
  }
  const ctx = canvas.getContext('2d');
  if (lineChartInstance) lineChartInstance.destroy();
  if (!labels || !vacancies || !hired) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = '14px sans-serif';
    ctx.fillText('No data available', 10, 30);
    return;
  }
  lineChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Total Vacancies',
          data: vacancies,
          borderColor: '#1976d2',
          backgroundColor: 'rgba(25, 118, 210, 0.1)',
          fill: false,
          tension: 0.3
        },
        {
          label: 'Total Hired',
          data: hired,
          borderColor: '#43a047',
          backgroundColor: 'rgba(67, 160, 71, 0.1)',
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true },
        title: { display: false }
      },
      scales: {
        x: { title: { display: true, text: 'Period' } },
        y: { title: { display: true, text: 'Count' }, beginAtZero: true }
      }
    }
  });
}

// Initial render
if (vacancyHiredLabels && totalVacanciesData && totalHiredData) {
  renderLineChart(vacancyHiredLabels.month, totalVacanciesData.month, totalHiredData.month);
}

// Period selector logic
const periodSelect = document.getElementById('periodSelect');
if (periodSelect) {
  periodSelect.addEventListener('change', function() {
    const period = this.value;
    if (vacancyHiredLabels && totalVacanciesData && totalHiredData) {
      renderLineChart(vacancyHiredLabels[period], totalVacanciesData[period], totalHiredData[period]);
    }
  });
}
</script>

<script>
// Count-up animation for metrics
function animateCount(id, end, suffix = '', duration = 3000) {
  const el = document.getElementById(id);
  if (!el) return;
  const isPercent = suffix === '%';
  const start = 0;
  const startTime = performance.now();
  function update(now) {
    const elapsed = now - startTime;
    let progress = Math.min(elapsed / duration, 1);
    let value = Math.floor(start + (end - start) * progress);
    if (isPercent) value = Math.min(value, end);
    el.textContent = value + suffix;
    if (progress < 1) {
      requestAnimationFrame(update);
    } else {
      el.textContent = end + suffix;
    }
  }
  requestAnimationFrame(update);
}
window.addEventListener('DOMContentLoaded', function() {
  animateCount('countApplicants', Number('{{ total_applicants|int }}'), '', 2000);
  animateCount('countHired', Number('{{ total_hired|int }}'), '', 2000);
  animateCount('countAttrition', Number('{{ attrition_score|int }}'), '%', 2000);
});
</script>

{% endblock %}
